# newsbot — агрегатор новостей о стройке в Нижегородской области

Собирает новости из источников (RSS/HTML), фильтрует по региональным ключевым словам. Тематика строительства учитывается как дополнительный критерий, помогает выделять профильные материалы, но не является обязательной. Удаляет дубликаты и публикует сообщения в Telegram-канал.

## Установка и зависимости
Python 3.10+
```bash
pip install -r requirements.txt
# при необходимости HTML-парсинга:
pip install beautifulsoup4
```

## Настройка
Настройка выполняется один раз через `.env` в директории профиля пользователя
(`%APPDATA%/NewsBot/.env` на Windows, `~/.config/NewsBot/.env` на Linux/macOS).
Файл рядом с кодом `WebWork/.env` при наличии **переопределяет** значения из
профильного. Создать основной файл можно командой:

```bash
python -m config init
```

Можно также скопировать шаблон `.env.example` и заполнить его — список переменных
ограничен только реально поддерживаемыми опциями, чтобы избежать путаницы с
неиспользуемыми параметрами изображений или внешних LLM.

Поддерживаются следующие переменные:
- `BOT_TOKEN`, `CHANNEL_ID`, `REVIEW_CHAT_ID`, `CHANNEL_CHAT_ID`
- `MODERATOR_IDS`, `SNOOZE_MINUTES`, `REVIEW_TTL_HOURS`, `RETRY_LIMIT`
- `ENABLE_REWRITE`, `STRICT_FILTER`, `LOG_LEVEL`, `DRY_RUN`
- `ON_SEND_ERROR`, `PUBLISH_MAX_RETRIES`, `RETRY_BACKOFF_SECONDS`
- `POLL_INTERVAL_SECONDS`, `FETCH_LIMIT_PER_SOURCE`
- `HTTP_TIMEOUT_CONNECT`, `HTTP_TIMEOUT_READ`, `HTTP_RETRY_TOTAL`, `HTTP_BACKOFF`
- `MAX_POST_LEN`, `CAPTION_LIMIT`, `REGION_HINT`, `PARSE_MODE`
- ключевые слова и источники в `newsbot/config.py`

### Рерайт

Базовый модуль рерайта работает полностью локально и не требует внешних LLM.
Он сокращает HTML‑тело новости и формирует безопасный текст под ограничение
Telegram.

По умолчанию достаточно присутствия региональных ключевых слов. Если установить `STRICT_FILTER=1`, бот будет требовать одновременно и регион, и строительную тематику.

Переменные `CHANNEL_ID`/`CHANNEL_CHAT_ID` и `REVIEW_CHAT_ID` должны быть заполнены
реальными идентификаторами каналов или чатов. Иначе попытка отправить сообщение
в Telegram завершится ошибкой вида `Bad Request: chat not found`.

В блоке `SOURCES` у каждого источника теперь есть флаг `enabled` и опциональные
поля `timeout`/`retry` для индивидуальных сетевых настроек.

## Быстрый старт
1. Скопируйте `.env.example` в профиль пользователя:
   ```bash
   cp WebWork/.env.example ~/.config/NewsBot/.env  # для Windows путь %APPDATA%/NewsBot/.env
   ```
2. Укажите в файле обязательные параметры:
   - `TELEGRAM_BOT_TOKEN` – токен бота;
   - `CHANNEL_CHAT_ID` (или `CHANNEL_ID`) – целевой канал;
   - при модерации (`ENABLE_MODERATION=1`) задайте `REVIEW_CHAT_ID` и `MODERATOR_IDS`.
3. При необходимости скорректируйте лимиты Telegram (`CAPTION_LIMIT`,
   `TELEGRAM_MESSAGE_LIMIT`).
4. При необходимости включите безопасный режим `DRY_RUN=1`, чтобы проверить фильтры без публикаций.
5. Запустите `python main.py`.

## Режим DRY-RUN

Установите `DRY_RUN=1`, чтобы бот не делал HTTP-запросы в Telegram. Все отправки
будут логироваться сообщением `[DRY-RUN: READY]`, а остальные шаги пайплайна —
фильтрация, рерайт, дедупликация — выполняются как в бою. Это позволяет
безопасно проверять настройки `.env`, источники и правила без риска
нежелательных публикаций.

## Источники

Конфигурация `sources_nn.yaml` описывает региональные источники с указанием
доверия, домена и разрешённых рубрик. В релизе подключены профильные площадки
строительной тематики:

- Минстрой НО — пресс-центр (`html`)
- Минград НО — пресс-центр (`html`)
- Администрация Нижнего Новгорода — новости (`html`)
- Инспекция госстройнадзора НО — новости (`html`)
- МЧС по Нижегородской области — новости (`html`)
- «Стратегия НО» — инфраструктура и благоустройство (`html`)
- Нижегородстат — раздел «Строительство» (`html`)
- ИА «Время Н» — RSS лента (`rss`)
- NewsNN — раздел «Строительство» (`html`)
- NN.RU — тег «Строительство» (`html`)
- «Домострой НН» — новости и статьи (`html`)
- РБК Нижний Новгород (урезан порог `min_text_length`, берём короткие заметки) (`html`)
- «В городе N» — раздел «Недвижимость» (`html`)
- НТА-Приволжье — ленты региона и экономики (`html`)
- «Коммерсантъ» — тема «Строительная отрасль НО» и регион 52 (снижен rate limit) (`html`)
- «ГИПЕРНН» — новости журнала о стройке (`html`)

Для каждого источника заданы `trust_level`, `rubrics_allowed`, сетевые лимиты,
`source_domain`, а также резервные поля `enable_video_scrape` и
`min_image_width` (медиа в этом релизе не обрабатываются). Селекторы для
HTML-страниц вынесены в `parsers/html.py`, RSS-ленты обрабатываются стандартным
модулем.

## Модерация

Файл `moderation.yaml` задаёт блок-листы и правила удержания на ревью.
Нецензурная лексика подгружается из `profanity_ru.txt`, дополнительно
блокируются шок-контент, политическая агитация и реклама. Раздел
`hold_for_review` помечает новости с тяжёлыми инцидентами, обвинениями,
персональными данными и сенсационной подачей. Для рубрики «Казусы» добавлены
жёсткие стоп-слова и требование указать качество/подтверждение в карточке.

`confirmation_rules` требуют надёжных подтверждений: новости об инцидентах
нуждаются в двух независимых источниках либо в источнике с `trust_level >= 3`,
а материалы рубрики `objects` должны подтверждаться официально или через два
разных домена.

`moderation.py` возвращает флаги для очереди, вычисляет `needs_confirmation`
и формирует сводку доверия (`min/avg/max`). В предпросмотре и публикации
отображаются рубрика и домен (`Рубрика: <b>…</b> · Источник: <i>домен</i>`), при
наличии флагов добавляется пометка «(после ревью)», а сообщения длиннее лимита
автоматически разбиваются на части с префиксами `(1/2)`, `(2/2)`.

Клавиатур больше нет: предпросмотр отправляется как текст, а публикация
в канал выполняется вручную по итогам правок. Исторический флаг
`MODERATION_BUTTONS_ENABLED` и похожие переменные можно удалить из конфигурации
— они устарели и не используются.

### Очистка клавиатур в существующих сообщениях

Если в модераторском чате уже есть сообщения с устаревшими кнопками,
воспользуйтесь скриптом `tools/strip_keyboards.py`. Укажите в файле список
`MESSAGE_IDS`, затем выполните:

```bash
BOT_TOKEN=123:ABC MOD_CHAT_ID=-100123456789 python tools/strip_keyboards.py
```

`BOT_TOKEN` — токен модераторского бота, `MOD_CHAT_ID` — идентификатор
модераторского чата (тот же, что и `REVIEW_CHAT_ID`). После выполнения
указанные сообщения останутся без встроенной клавиатуры.

## Запуск
Разово:
```bash
python main.py
```
Цикл:
```bash
python main.py --loop
```

Для локального теста без отправки в Telegram установите `DRY_RUN=1` в `.env`
или передайте переменную окружения при запуске: `DRY_RUN=1 python main.py`.

## Бот-приёмная

1. Получите отдельного бота у [@BotFather](https://t.me/BotFather): команда `/newbot` вернёт токен вида `123456789:ABC...`. Сохраните его в переменной `SUGGEST_BOT_TOKEN`.
2. Добавьте бота администратором в чат модерации, где команда будет разбирать заявки. Идентификатор чата (`SUGGEST_MOD_CHAT_ID`) можно узнать через `/getchatid` в @RawDataBot или создать пригласительную ссылку командой `/createChatInviteLink` и открыть её — ID будет в URL вида `-100...`.
3. Пропишите параметры в `.env`:
   ```ini
   SUGGEST_BOT_TOKEN=123456789:ABC...
   SUGGEST_MOD_CHAT_ID=-1001122334455
   # опционально: убрать метку «переслано»
   SUGGEST_USE_COPY=1
   # при необходимости — собственный текст приветствия
   SUGGEST_HELLO=👋 Добрый день! Пришлите, пожалуйста, новость…
   ```
4. При желании настройте команды через @BotFather (`/setcommands`) или запросом `setMyCommands` с полезной нагрузкой:
   ```json
   [
     {"command": "start", "description": "Запуск подачи новости"},
     {"command": "help", "description": "Краткая инструкция"},
     {"command": "privacy", "description": "Как обрабатываются данные"},
     {"command": "cancel", "description": "Отменить текущий шаг"}
   ]
   ```
5. Запускайте приёмную отдельным процессом:
   ```bash
   python -m suggest_bot
   ```
6. Для кнопки «Предложить новость» используйте диплинк `https://t.me/<имя_бота>?start=suggest`. После перехода бот пришлёт инструкцию и пересылает каждое сообщение в чат модерации.

## Запуск через PowerShell
Полный пример для Windows:

```powershell
# клонирование и переход в каталог проекта
git clone <URL_репозитория>
cd WebWork

# при желании создаём виртуальное окружение
py -3 -m venv .venv
.\.venv\Scripts\Activate.ps1

# установка зависимостей
pip install -r requirements.txt

# однократная инициализация конфигурации (.env создастся в профиле пользователя)
python -m config init

# запуск одного прохода
python .\main.py

# запуск в бесконечном цикле
python .\main.py --loop
```

## Развертывание службы

### Systemd (Linux)

Создайте юнит `/etc/systemd/system/newsbot.service`:

```ini
[Unit]
Description=NewsBot aggregator
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
WorkingDirectory=/opt/newsbot
ExecStart=/opt/newsbot/.venv/bin/python -m main --loop
Restart=on-failure
RestartSec=5
Environment=PYTHONUNBUFFERED=1

[Install]
WantedBy=multi-user.target
```

Скопируйте код в `/opt/newsbot`, создайте виртуальное окружение, заполните
`~newsbot/.config/NewsBot/.env` и включите службу:

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now newsbot.service
```

### Docker

Минимальный `Dockerfile` для непрерывного запуска:

```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY . .
RUN pip install --no-cache-dir -r requirements.txt
CMD ["python", "main.py", "--loop"]
```

При запуске пробросьте `.env` и том с базой данных:

```bash
docker build -t newsbot .
docker run -d --name newsbot \
  -v $HOME/.config/NewsBot/.env:/root/.config/NewsBot/.env:ro \
  -v newsbot_db:/root/.config/NewsBot/newsbot.db \
  newsbot
```

## Формат логов
`YYYY-MM-DD HH:MM:SS | LEVEL | logger | message` — решения по каждой новости: `[SKIP]`, `[DUP-DB]`, `[DRY-RUN: READY]`, `[PUBLISHED]`.

## Ограничения Telegram
Лимит 4096 символов; бот экранирует разметку и сокращает тело, не повреждая формат.

## Схема пайплайна

1. **Фильтрация** — новости отбрасываются, если не содержат упоминаний
   Нижегородской области.
2. **Рерайт** — `rewriter.Rewriter` формирует укороченный безопасный текст.
   Длина поста ограничивается `MAX_POST_LEN`, с учётом экранирования Markdown/HTML.
3. **Публикация** — текст отправляется в канал с учётом лимитов Telegram и
   автоматических ретраев.

## Антидубликаты
SQLite ведёт две таблицы: `items` хранит опубликованные записи, `dedup` — только
отпечатки URL/GUID/заголовков для быстрого сравнения. Повторные прогоны не шлют
дубли за счёт проверки всех трёх ключей.

## Обслуживание БД
Очистка истории выполняется автоматически после каждой итерации:

- `ITEM_RETENTION_DAYS` — сколько дней хранить подробные записи в `items`.
- `DEDUP_RETENTION_DAYS` — срок хранения отпечатков в `dedup`.
- `DB_PRUNE_BATCH` — сколько строк удаляется за один проход (чтобы не держать
  блокировки слишком долго).

### Бэкапы

База SQLite находится по пути `~/.config/NewsBot/newsbot.db`. Для безопасного
резервного копирования выполните:

```bash
sqlite3 ~/.config/NewsBot/newsbot.db \
  ".timeout 2000" \
  ".backup '/var/backups/newsbot-$(date +%F).db'"
```

В Docker-окружении подключите том `newsbot_db` и периодически копируйте файл
`newsbot.db`. Проверяйте каждую копию командой
`sqlite3 backup.db 'PRAGMA integrity_check;'`.

## Мониторинг источников
Бот ведёт статистику неудачных запросов к источникам. Если хост подряд
возвращает ошибки, появится предупреждение в логах (порог —
`HOST_FAIL_ALERT_THRESHOLD` обращений за `HOST_FAIL_ALERT_WINDOW_SEC`). При
успешном ответе лог фиксирует восстановление.

## Модерация
Если `ENABLE_MODERATION=1`, каждое сообщение сначала попадает в чат ревью `REVIEW_CHAT_ID`.
Предпросмотр без клавиатуры; публикация выполняется вручную (копированием текста).

Список модераторов задаётся через переменную окружения `MODERATOR_IDS`.
При откладывании поле `resume_at` в таблице `moderation_queue` заполняется
временем возврата в очередь.
