# Отчет об аудите проекта WebWork

## 1. Назначение системы
WebWork — агрегатор новостей и Telegram-постов для ленты о строительстве в
Нижегородской области. Он собирает контент по RSS/HTML и через официальное API
Telegram, затем прогоняет его через фильтрацию, тегирование, дедупликацию,
рерайт, модерацию и публикацию в каналы Telegram.【F:README.md†L1-L13】

## 2. Структура пайплайна
Основной сценарий `main.py` выстраивает последовательность обработки,
опираясь на конфигурацию и внешние модули. Пайплайн включает сбор данных,
фильтрацию, категоризацию, дедупликацию, рерайт, модерацию и публикацию в
каналы, а также независимую RAW-ветку для ручной проверки материалов.【F:main.py†L1-L113】【F:README.md†L9-L48】

## 3. Ключевые компоненты
- **Сбор**: модуль `fetcher.fetch_all` объединяет RSS/HTML-источники, а
  `telegram_fetcher.fetch_from_telegram` обеспечивает сбор через Bot API и
  MTProto в зависимости от настроек `TELEGRAM_MODE`. Источники описаны в
  `sources.py` и YAML-конфигурациях.【F:main.py†L67-L105】【F:sources.py†L1-L120】【F:sources_nn.yaml†L1-L120】
- **Фильтрация и категоризация**: `filters.is_relevant_for_source`,
  `tagging.extract_tags` и модуль `classifieds` отсеивают нерелевантные и
  рекламные сообщения перед дальнейшей обработкой.【F:main.py†L106-L156】【F:filters.py†L1-L180】【F:tagging.py†L1-L200】
- **Дедупликация**: `dedup` и `utils.compute_title_hash` устраняют повторы по
  URL и заголовкам, предотвращая повторную публикацию контента.【F:main.py†L145-L188】【F:dedup.py†L1-L220】【F:utils.py†L1-L200】
- **Рерайт**: модули `rewrite` и пакет `autorewrite/` готовят текст к
  публикации, обрабатывая формулировки и форматирование, а также поддерживают
  альтернативные сценарии fallback через `rewriter_module.py`.【F:rewrite.py†L1-L200】【F:autorewrite/__init__.py†L1-L160】【F:rewriter_module.py†L1-L220】
- **Модерация**: `moderation`, `moderator` и очередь в `moderation.yaml`
  реализуют ручную проверку, а `raw_pipeline.py` обслуживает RAW-поток для
  ревью, включая кастомные списки каналов и обход фильтров при необходимости.【F:moderation.py†L1-L220】【F:moderator.py†L1-L200】【F:raw_pipeline.py†L1-L220】
- **Публикация**: `publisher.publish_structured_item` и пакет `webwork/`
  (включая `router.py` и `publisher.py`) маршрутизируют сообщения в текстовый и
  медиа-каналы Telegram с учетом ограничений Bot API и настроек DRY-RUN.【F:main.py†L25-L66】【F:webwork/publisher.py†L1-L200】【F:webwork/router.py†L1-L200】

## 4. Конфигурация и внешние данные
- Основные настройки загружаются из `config.py` и `config_defaults.py`, которые
  поддерживают режимы `ONLY_TELEGRAM`, `RAW_STREAM_ENABLED` и связные параметры.
- Файлы `telegram_links.txt` и `telegram_links_raw.txt` задают списки каналов
  для основной и RAW-веток соответственно, а `tag_rules.yaml` и
  `moderation.yaml` описывают правила тегирования и ручной модерации.【F:config.py†L1-L320】【F:config_defaults.py†L1-L200】【F:telegram_links.txt†L1-L200】【F:telegram_links_raw.txt†L1-L200】【F:tag_rules.yaml†L1-L120】【F:moderation.yaml†L1-L120】

## 5. Проверка работоспособности
Полный набор автоматических тестов `pytest` успешно проходит (91 тест).
Команда выполнялась из корня репозитория и подтверждает работоспособность
пайплайна, парсеров, форматирования, модерации и телеграмных интеграций на
уровне модульных тестов.【3447b6†L1-L30】

## 6. Рекомендации по дальнейшему контролю
1. Включить регулярный прогон `pytest` в CI, чтобы гарантировать целостность
   пайплайна перед деплоем.
2. Контролировать актуальность списков Telegram-каналов и YAML-конфигураций,
   поскольку они напрямую влияют на охват и точность фильтрации.
3. Периодически проверять `requirements.txt` на обновления библиотек для
   поддержания безопасности и совместимости.

